#!/usr/bin/env groovy

pipeline {
   agent any
   stages {
       stage('Initialise') {
           steps {
                  sh 'rm -rf cloudnativeex'
                  sh 'git clone https://github.com/shreyach13/cloudnativeex.git'
                  echo "Initialising job - cloning repo"
                  dir("cloudnativeex/terraform/Build-Jenkins-AMI_and_EC2/Step1_Build-Jenkins-AMI/"){
                    sh 'pwd'
                  }
                }
           }
      stage('Validate') {
        steps {
        dir("cloudnativeex/terraform/Build-Jenkins-AMI_and_EC2/Step1_Build-Jenkins-AMI/"){
          sh 'pwd'
          sh 'ls -al'
          echo "Validating PACKER json..."
          sh 'packer validate packer_jenkins_ami.json > packer_validate_out.txt'
          sh 'cat packer_validate_out.txt'
        }
        }
      }
      stage('Build') {
        steps {
          dir("cloudnativeex/terraform/Build-Jenkins-AMI_and_EC2/Step1_Build-Jenkins-AMI/"){
            sh 'packer build packer_jenkins_ami.json'
          }
        }
      }

           }
           }
